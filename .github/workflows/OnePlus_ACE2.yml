name: OnePlus Ace2 Kernel Build

on:
  workflow_dispatch:
    inputs:
      ksu:
        description: "启用KSU"
        required: false
        type: boolean
        default: false
      better_net:
        description: "是否开启网络功能增强配置"
        required: false
        type: boolean
        default: true
      baseband_guard:
        description: "是否开启内核级基带保护"
        required: true
        type: boolean
        default: false

jobs:
  build:
    name: OnePlus Ace2 Kernel Build
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "none"
      CCACHE_COMPRESS: "1"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_DIR: ${{ github.workspace }}/.ccache_oneplus_ace2
      CCACHE_MAXSIZE: "3G"

    steps:
      - uses: actions/checkout@v4
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Check Disk Space
        run: df -h

      - name: Create and Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install dependencies
        run: |
          sudo apt-get install -y --no-install-recommends libelf-dev tree dos2unix ccache python3

      - name: Configure Git and repo
        run: |
          git config --global user.email "bot@kernelsu.org"
          git config --global user.name "KernelSUBot"
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize repo and sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          mkdir -p .repo/manifests
          repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -b oneplus/sm8475 -m oneplus_ace2_v.xml --repo-rev=stable --depth=1 --no-clone-bundle --no-tags
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

          for dir in kernel_platform/common kernel_platform/msm-kernel; do
            if [ -e "$dir/BUILD.bazel" ]; then
              sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' "$dir/BUILD.bazel"
            fi
            rm -f "$dir/android/abi_gki_protected_exports_"* 2>/dev/null || echo "No protected exports in $dir"
          done
          
      - name: Setup KSU
        if: ${{ inputs.ksu }}
        run: |
          cd kernel_workspace/kernel_platform
          curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash -
          
          cd KernelSU
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=short)
          BRANCH_OR_TAG=$(git describe --tags 2>/dev/null || git branch --show-current)

          echo "=== KernelSU Version Information ==="
          echo "版本: $BRANCH_OR_TAG"
          echo "Commit Hash: $COMMIT_HASH"
          echo "Commit Date: $COMMIT_DATE"

      - name: Add iptables extensions
        if: ${{ inputs.better_net }}
        run: |
          cd kernel_workspace/kernel_platform/common
          {
            echo "CONFIG_BPF_STREAM_PARSER=y"
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y"
            echo "CONFIG_NETFILTER_XT_SET=y"
            echo "CONFIG_IP_SET=y"
            echo "CONFIG_IP_SET_MAX=65534"
            echo "CONFIG_IP_SET_BITMAP_IP=y"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y"
            echo "CONFIG_IP_SET_BITMAP_PORT=y"
            echo "CONFIG_IP_SET_HASH_IP=y"
            echo "CONFIG_IP_SET_HASH_IPMARK=y"
            echo "CONFIG_IP_SET_HASH_IPPORT=y"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y"
            echo "CONFIG_IP_SET_HASH_IPMAC=y"
            echo "CONFIG_IP_SET_HASH_MAC=y"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y"
            echo "CONFIG_IP_SET_HASH_NET=y"
            echo "CONFIG_IP_SET_HASH_NETNET=y"
            echo "CONFIG_IP_SET_HASH_NETPORT=y"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y"
            echo "CONFIG_IP_SET_LIST_SET=y"
            echo "CONFIG_IP6_NF_NAT=y"
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y"
          } >> ./arch/arm64/configs/gki_defconfig

      - name: Setup Baseband-guard
        if: ${{ inputs.baseband_guard }}
        run: |
          cd kernel_workspace/kernel_platform/common
          curl -LSs "https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh" | bash
          echo "CONFIG_BBG=y" >> ./arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      - name: Other tasks
        run: |
          cd kernel_workspace/kernel_platform/common
          # 设置 LTO 以防止爆炸
          sed -i 's/^CONFIG_LTO=n/CONFIG_LTO=y/' ./arch/arm64/configs/gki_defconfig
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' ./arch/arm64/configs/gki_defconfig
          sed -i 's/^CONFIG_LTO_CLANG_NONE=y/CONFIG_LTO_CLANG_THIN=y/' ./arch/arm64/configs/gki_defconfig
          grep -q '^CONFIG_LTO_CLANG_THIN=y' ./arch/arm64/configs/gki_defconfig || echo 'CONFIG_LTO_CLANG_THIN=y' >> ./arch/arm64/configs/gki_defconfig
          # 跳过将 uapi 标准头安装到 usr/include 目录的不必要操作，节省编译时间
          echo "CONFIG_HEADERS_INSTALL=n" >> ./arch/arm64/configs/gki_defconfig
          # 开启 O2 编译优化配置
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./arch/arm64/configs/gki_defconfig
          # 禁用 defconfig 检查
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Rename make name
        run: |
          cd kernel_workspace/kernel_platform
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          sed -i 's/-4k//g' ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/ -dirty//g' ./common/scripts/setlocalversion
          sed -i 's/ -dirty//g' ./msm-kernel/scripts/setlocalversion
          sed -i 's/ -dirty//g' ./external/dtc/scripts/setlocalversion
          # 在 common/scripts/setlocalversion 的 OPLUS 部分后添加自定义字符串
          sed -i '/#endif OPLUS_FEATURE_BUILD/i\\tprintf '"'%s'"' "-Mortis"' ./common/scripts/setlocalversion
          # 在 msm-kernel/scripts/setlocalversion 的 android_release 后添加自定义字符串
          sed -i '/printf.*android_release"/a\\tprintf '"'%s'"' "-Mortis"' ./msm-kernel/scripts/setlocalversion
          # sed -i '$s|echo "\$res"|echo "-Mortis\$res"|' ./common/scripts/setlocalversion
          # sed -i '$s|echo "\$res"|echo "${res/-g/-Mortis-g}"|' ./msm-kernel/scripts/setlocalversion
          # echo "-Mortis" > ./common/localversion
          # echo "-Mortis" > ./msm-kernel/localversion          
          # sed -i '$s|echo "\$res"|echo "-Yukino"|' ./common/scripts/setlocalversion            
          # sed -i '$s|echo "\$res"|echo "-Yukino"|' ./msm-kernel/scripts/setlocalversion
          # sed -i '$s|echo "\$res"|echo "-Yukino"|' ./external/dtc/scripts/setlocalversion
          
      - name: Build Kernel
        run: |
          cd kernel_workspace
          LTO=thin SYSTEM_DLKM_RE_SIGN=0 BUILD_SYSTEM_DLKM=0 KMI_SYMBOL_LIST_STRICT_MODE=0 \
          ./kernel_platform/oplus/build/oplus_build_kernel.sh waipio gki

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/Kernel-SU/AnyKernel3.git --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir -p kernel_workspace/kernel_platform/out/Final-Image-Find/
          image_path=$(find "./kernel_workspace/kernel_platform/common/out/" -name "Image" | head -n 1)
          if [ -z "$image_path" ]; then
            image_path=$(find "./kernel_workspace/kernel_platform/out/" -name "Image" | head -n 1)
          fi
          if [ -n "$image_path" ] && [ -f "$image_path" ]; then
            cp "$image_path" ./AnyKernel3/Image
            cp "$image_path" kernel_workspace/kernel_platform/out/Final-Image-Find/Image
          else
            echo "未找到 Image 文件"
            exit 1
          fi

      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: Ace2_AnyKernel3${{ inputs.ksu && '_KSU' || '' }}${{ inputs.better_net && '_IPT' || '' }}${{ inputs.baseband_guard && '_BBG' || '' }}
          path: ./AnyKernel3/*

      # - name: Upload to telegram
        # run: |
          # if [ ! -z "${{ secrets.BOT_TOKEN }}" ]; then
            # echo "Ziping AK3..."
            # zip -r Ace2_AnyKernel3${{ inputs.ksu && '_KSU' || '' }}${{ inputs.better_net && '_IPT' || '' }}${{ inputs.baseband_guard && '_BBG' || '' }}.zip ./AnyKernel3/*
            # echo "Uploading to the Telegram..."
            # pip3 install telethon
            # python3 ./script/buildbot.py "./Ace2_AnyKernel3${{ inputs.ksu && '_KSU' || '' }}${{ inputs.better_net && '_IPT' || '' }}${{ inputs.baseband_guard && '_BBG' || '' }}.zip"
            # echo "Uploaded to the Telegram"
          # fi
        # env:
          # CHATID: ${{secrets.CHATID}}
          # BOT_TOKEN: ${{secrets.BOT_TOKEN}}
          # MESSAGE_THREAD_ID: ${{secrets.MESSAGE_THREAD_ID}}
