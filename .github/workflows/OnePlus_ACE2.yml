name: OnePlus Ace2 Kernel Build

on:
  workflow_dispatch:
    inputs:
      ksu:
        description: "启用KSU"
        required: false
        type: boolean
        default: false
      better_net:
        description: "是否开启网络功能增强配置"
        required: false
        type: boolean
        default: true
      baseband_guard:
        description: "是否开启内核级基带保护"
        required: true
        type: boolean
        default: false
      lz4kd:
        description: "是否启用lz4kd压缩算法"
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: OnePlus Ace2 Kernel Build
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: "8G"

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Cache Env
        run: |
          echo "设置机型隔离缓存目录..."
          echo "CCACHE_DIR=$HOME/.ccache_oneplus_ace2_kernel" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_oneplus_ace2_kernel"
          echo "缓存目录已设置: $HOME/.ccache_oneplus_ace2_kernel"

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Check Disk Space
        run: df -h

      - name: Create and Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest 
        with: 
          packages: python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip gawk dos2unix
          execute_install_scripts: true

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref }}-oneplus_ace2-kernel
          restore-keys: |
            ccache-${{ runner.os }}-oneplus_ace2-kernel
            ccache-${{ runner.os }}-kernel

      - name: Initialize ccache
        run: |
          echo "初始化ccache..."
          INIT_FLAG="${{ env.CCACHE_DIR }}/.ccache_initialized"
          
          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              mkdir -p "${{ env.CCACHE_DIR }}"
              ccache -M ${{ env.CCACHE_MAXSIZE }}
              touch "$INIT_FLAG"
              echo "ccache初始化完成"
            else
              echo "ccache已存在，跳过初始化"
            fi
          else
            echo "未找到ccache命令，跳过初始化"
          fi
          ccache -s
          echo "ccache初始化流程完成"

      - name: Configure Git and repo
        run: |
          git config --global user.email "bot@kernelsu.org"
          git config --global user.name "KernelSUBot"
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize repo and sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          mkdir -p .repo/manifests
          repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -b oneplus/sm8475 -m oneplus_ace2_v.xml --repo-rev=stable --depth=1 --no-clone-bundle --no-tags
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

          for dir in kernel_platform/common kernel_platform/msm-kernel; do
            if [ -e "$dir/BUILD.bazel" ]; then
              sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' "$dir/BUILD.bazel"
            fi
            rm -f "$dir/android/abi_gki_protected_exports_"* 2>/dev/null || echo "No protected exports in $dir"
          done
          
      - name: Setup ZRAM and lz4kd
        run: |
          cd kernel_workspace
          echo "下载ZRAM补丁..."
          git clone https://github.com/Xiaomichael/kernel_patches.git
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          
          cd kernel_platform
          echo "复制补丁文件..."
          cp ../kernel_patches/zram/001-lz4.patch ./common/
          cp ../kernel_patches/zram/lz4armv8.S ./common/lib
          cp ../kernel_patches/zram/002-zstd.patch ./common/
          
          if [ "${{ inputs.lz4kd }}" == "true" ]; then
            echo "复制lz4k文件..."
            cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux
            cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib
            cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto
            cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          fi
          
          echo "应用补丁..."
          cd ./common
          
          if [ "${{ inputs.lz4kd }}" == "false" ]; then
            echo "应用lz4+zstd补丁..."
            git apply -p1 < 001-lz4.patch || true
            patch -p1 < 002-zstd.patch || true
          fi
          
          if [ "${{ inputs.lz4kd }}" == "true" ]; then
            echo "应用lz4kd补丁..."
            cp ../../SukiSU_patch/other/zram/zram_patch/5.10/lz4kd.patch ./
            patch -p1 -F 3 < lz4kd.patch || true
            cp ../../SukiSU_patch/other/zram/zram_patch/5.10/lz4k_oplus.patch ./
            patch -p1 -F 3 < lz4k_oplus.patch || true
          fi
          
          echo "所有补丁应用完成"

      - name: Setup KSU
        if: ${{ inputs.ksu }}
        run: |
          cd kernel_workspace/kernel_platform
          curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash -
          
          cd KernelSU
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=short)
          BRANCH_OR_TAG=$(git describe --tags 2>/dev/null || git branch --show-current)

          echo "=== KernelSU Version Information ==="
          echo "版本: $BRANCH_OR_TAG"
          echo "Commit Hash: $COMMIT_HASH"
          echo "Commit Date: $COMMIT_DATE"

      - name: Add iptables extensions
        if: ${{ inputs.better_net }}
        run: |
          cd kernel_workspace/kernel_platform/common
          {
            echo "CONFIG_BPF_STREAM_PARSER=y"
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y"
            echo "CONFIG_NETFILTER_XT_SET=y"
            echo "CONFIG_IP_SET=y"
            echo "CONFIG_IP_SET_MAX=65534"
            echo "CONFIG_IP_SET_BITMAP_IP=y"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y"
            echo "CONFIG_IP_SET_BITMAP_PORT=y"
            echo "CONFIG_IP_SET_HASH_IP=y"
            echo "CONFIG_IP_SET_HASH_IPMARK=y"
            echo "CONFIG_IP_SET_HASH_IPPORT=y"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y"
            echo "CONFIG_IP_SET_HASH_IPMAC=y"
            echo "CONFIG_IP_SET_HASH_MAC=y"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y"
            echo "CONFIG_IP_SET_HASH_NET=y"
            echo "CONFIG_IP_SET_HASH_NETNET=y"
            echo "CONFIG_IP_SET_HASH_NETPORT=y"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y"
            echo "CONFIG_IP_SET_LIST_SET=y"
            echo "CONFIG_IP6_NF_NAT=y"
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y"
          } >> ./arch/arm64/configs/gki_defconfig

      - name: Setup Baseband-guard
        if: ${{ inputs.baseband_guard }}
        run: |
          cd kernel_workspace/kernel_platform/common
          curl -LSs "https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh" | bash
          echo "CONFIG_BBG=y" >> ./arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      - name: Configure Kernel Options
        run: |
          echo "Configure kernel compilation options..."
          
          cd kernel_workspace/kernel_platform/common
          
          if [ "${{ inputs.lz4kd }}" == "true" ]; then
            echo "Enable the lz4kd compression algorithm..."
            echo "CONFIG_CRYPTO_LZ4KD=y" >> ./arch/arm64/configs/gki_defconfig
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> ./arch/arm64/configs/gki_defconfig
            echo "CONFIG_ZRAM_WRITEBACK=y" >> ./arch/arm64/configs/gki_defconfig
          fi
          
          echo "Kernel configuration update completed."

      - name: Other tasks
        run: |
          cd kernel_workspace/kernel_platform/common
          # 设置 LTO 以防止爆炸
          sed -i 's/^CONFIG_LTO=n/CONFIG_LTO=y/' ./arch/arm64/configs/gki_defconfig
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' ./arch/arm64/configs/gki_defconfig
          sed -i 's/^CONFIG_LTO_CLANG_NONE=y/CONFIG_LTO_CLANG_THIN=y/' ./arch/arm64/configs/gki_defconfig
          grep -q '^CONFIG_LTO_CLANG_THIN=y' ./arch/arm64/configs/gki_defconfig || echo 'CONFIG_LTO_CLANG_THIN=y' >> ./arch/arm64/configs/gki_defconfig
          # 跳过将 uapi 标准头安装到 usr/include 目录的不必要操作，节省编译时间
          echo "CONFIG_HEADERS_INSTALL=n" >> ./arch/arm64/configs/gki_defconfig
          # 开启 O2 编译优化配置
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> ./arch/arm64/configs/gki_defconfig
          # 禁用 defconfig 检查
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Rename make name
        run: |
          cd kernel_workspace/kernel_platform
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          sed -i 's/-4k//g' ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/ -dirty//g' ./common/scripts/setlocalversion
          sed -i 's/ -dirty//g' ./msm-kernel/scripts/setlocalversion
          sed -i 's/ -dirty//g' ./external/dtc/scripts/setlocalversion
          sed -i '/#ifdef OPLUS_FEATURE_BUILD/,/#endif OPLUS_FEATURE_BUILD/ {
            s/local oki_infix=o/local oki_infix=Mortis/
          }' ./common/scripts/setlocalversion

      - name: Build Kernel
        env:
          PATH: "/usr/lib/ccache:$PATH"
        run: |
          cd kernel_workspace/kernel_platform/common
          export PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin:$PATH"
          sudo apt install libelf-dev
          make -j$(nproc --all) LLVM_IAS=1 LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out gki_defconfig all
          
          # 显示ccache统计信息
          ccache -s
          echo "内核编译完成"

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/Kernel-SU/AnyKernel3.git --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir -p kernel_workspace/kernel_platform/out/Final-Image-Find/
          image_path=$(find "./kernel_workspace/kernel_platform/common/out/" -name "Image" | head -n 1)
          if [ -z "$image_path" ]; then
            image_path=$(find "./kernel_workspace/kernel_platform/out/" -name "Image" | head -n 1)
          fi
          if [ -n "$image_path" ] && [ -f "$image_path" ]; then
            cp "$image_path" ./AnyKernel3/Image
            cp "$image_path" kernel_workspace/kernel_platform/out/Final-Image-Find/Image
          else
            echo "未找到 Image 文件"
            exit 1
          fi

      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: Ace2_AnyKernel3${{ inputs.ksu && '_KSU' || '' }}${{ inputs.better_net && '_IPT' || '' }}${{ inputs.baseband_guard && '_BBG' || '' }}${{ inputs.lz4kd && '_LZ4KD' || '' }}
          path: ./AnyKernel3/*